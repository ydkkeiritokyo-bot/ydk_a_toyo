
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ±äº¬éƒ½ãƒ»å¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆå¤©æ°—ï¼ˆJMA + OpenWeather + AMeDASeDtitle>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; margin: 0; background:#13411A; color:#e5e7eb;}
    header { padding: 16px 20px; border-bottom: 1px solid #334155;}
    h1 { font-size: 18px; margin: 0; }
    main { display: grid; gap: 16px; padding: 16px; }
    section { background:#111827; border: 1px solid #374151; border-radius: 10px; padding: 16px; }
    section h2 { font-size: 16px; margin: 0 0 8px; }
    .row { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .card { background:#0b1221; border: 1px solid #1f2937; border-radius: 8px; padding: 10px; }
    .small { font-size: 12px; opacity:.8 }
    .ok { color:#22c55e } .warn { color:#f59e0b } .bad { color:#ef4444 }
    .grid { display: grid; gap: 6px; grid-template-columns: repeat(7,1fr); }
    .grid .cell { padding: 6px; border: 1px solid #374151; border-radius:6px; text-align:center; font-size:13px; }
    label { display:block; margin: 4px 0 8px; }
    input, select, button { font: inherit; border-radius: 6px; border: 1px solid #374151; background:#0b1221; color:#e5e7eb; padding: 8px; }
    button { cursor: pointer; }
    .flex { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color:#94a3b8; }
    .error { color:#ef4444; }
    .footnote { font-size:11px; color:#a1a1aa; }
    a { color:#93c5fd; }
  </style>
</head>
<body>
<header>
  <h1>â›„æ±äº¬éƒ½ãƒ»å¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆå¤©æ°—ğŸŒ</h1>
  <div class="small muted">ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ï¼šæ°—è±¡åº/JMAï¼ˆéƒ½çœŒäºˆå ±ï¼†AMeDASï¼‰ã€OpenWeatherMapï¼ˆå¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆäºˆå ±ï¼‰</div>
</header>

<main>
  <!-- â‘  JMAï¼šæ±äº¬éƒ½ã®3æ—¥/7æ—¥äºˆå ±ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰ -->
  <section id="jma">
    <h2>æ±äº¬éƒ½ã®äºˆå ±ï¼ˆJMAï¼‰</h2>
    <div class="small muted">æ›´æ–°ï¼š<span id="jmaUpdated">èª­ã¿è¾¼ã¿ä¸­...</span>ï½œå¯¾è±¡ï¼šæ±äº¬åœ°æ–¹ï¼ˆ3æ—¥ï¼‰ï¼‹é€±é–“ï¼ˆ7æ—¥ï¼‰</div>
    <div class="row">
      <div class="card">
        <div><strong>3æ—¥é–“ã®å¤©æ°—ãƒ»é¢¨</strong></div>
        <div id="jma3d">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="card">
        <div><strong>é™æ°´ç¢ºç‡ï¼ˆ6æ™‚é–“åŒºåˆ‡ã‚Šï¼‰</strong></div>
        <div id="jmaPop">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="card">
        <div><strong>æ°—æ¸©ï¼ˆæœ€é«˜/æœ€ä½ï¼‰</strong></div>
        <div id="jmaTemp">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="card">
        <div><strong>é€±é–“å¤©æ°—ï¼ˆ7æ—¥ï¼‰</strong></div>
        <div id="jmaWeekly">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    <div class="footnote">JMAã®äºˆå ±JSONã¯ <code>/bosai/forecast/data/forecast/130000.json</code> ã‚’åˆ©ç”¨ï¼ˆæ±äº¬éƒ½ï¼‰ã€‚ç™ºè¡¨ã¯é€šå¸¸ 5æ™‚/11æ™‚/17æ™‚ã®1æ—¥3å›ã€‚æ§‹é€ ã¯3æ—¥äºˆå ±ï¼‹é€±é–“äºˆå ±ã§ timeSeries ãŒåˆ†ã‹ã‚Œã‚‹ã€‚ </div>
  </section>

  <!-- â‘¡ AMeDASï¼šè¿‘å‚è¦³æ¸¬æ‰€ã®æœ€æ–°å€¤ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰ -->
  <section id="amedas">
    <h2>ä»Šã®æ°—è±¡ï¼ˆAMeDASè¦³æ¸¬å€¤ï¼‰</h2>
    <div class="flex">
      <label>è¦³æ¸¬æ‰€IDï¼ˆ5æ¡ï¼‰ï¼š<input id="amdId" value="44132" /></label>
      <button id="amdLoad">æœ€æ–°ã‚’å–å¾—</button>
      <span class="small muted">â€»è¦³æ¸¬æ‰€IDã¯JMAã‚¢ãƒ¡ãƒ€ã‚¹ã®è©³ç´°ãƒšãƒ¼ã‚¸URLæœ«å°¾ã® <code>#amdno=XXXXX</code> ã§ç¢ºèªå¯</span>
    </div>
    <div id="amdResult" class="row">
      <div class="card"><div id="amdMeta">èª­ã¿è¾¼ã¿å¾…ã¡...</div></div>
      <div class="card"><div id="amdVals">â€”</div></div>
    </div>
    <div class="footnote">AMeDASã®å…¨å›½æœ€æ–°ã¯ <code>/bosai/amedas/data/latest_time.txt</code> â†’ <code>/bosai/amedas/data/map/{YYYYMMDDHHMMSS}.json</code> ã®é †ã§å–å¾—ã€‚å„åœ°ç‚¹ã‚­ãƒ¼ã«è¦³æ¸¬å€¤ï¼ˆæ°—æ¸©/é™æ°´/é¢¨/æ¹¿åº¦â€¦ï¼‰ãŒé…åˆ—ã§å…¥ã‚‹ã€‚</div>
  </section>

  <!-- â‘¢ OpenWeatherMapï¼šå¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆäºˆå ±ï¼ˆAPIã‚­ãƒ¼è¦ï¼‰ -->
  <section id="owm">
    <h2>å¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆï¼ˆOpenWeatherMapï¼‰</h2>
    <div class="flex">
      <label>APIã‚­ãƒ¼ï¼š<input id="owmKey" placeholder="YOUR_OWM_API_KEY" /></label>
      <label>éƒ½å¸‚ï¼ˆä¾‹ï¼šChofu,JPï¼‰ï¼š<input id="owmCity" value="Chofu,JP" /></label>
      <button id="owmLoad">å–å¾—</button>
    </div>
    <div id="owmStatus" class="small muted">æœªå–å¾—</div>
    <div class="row">
      <div class="card">
        <div><strong>ç¾åœ¨ã®å¤©æ°—</strong></div>
        <div id="owmCurrent">â€”</div>
      </div>
      <div class="card">
        <div><strong>5æ—¥é–“ï¼ˆ3æ™‚é–“åˆ»ã¿ï¼‰</strong></div>
        <div id="owm5d">â€”</div>
      </div>
    </div>
    <div class="footnote">OpenWeatherã®ç¾åœ¨ãƒ»5æ—¥äºˆå ±APIã‚’åˆ©ç”¨ï¼ˆè¨€èª=jaã€å˜ä½=metricï¼‰ã€‚ç„¡æ–™æ ã‚ã‚Šã€‚éƒ½å¸‚åã¾ãŸã¯ç·¯åº¦çµŒåº¦ã§æŒ‡å®šå¯èƒ½ã€‚</div>
  </section>
</main>

<script>
/** ===== â‘  JMA æ±äº¬éƒ½ã®äºˆå ± =====
 *  å‚ç…§: https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json
 *  3æ—¥äºˆå ±/é€±é–“äºˆå ±ã® timeSeries ã‚’æ•´å½¢ã—ã¦è¡¨å½¢å¼ã§å‡ºã™
 */
(async function loadJMA() {
  const url = 'https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json';
  try {
    const res = await fetch(url);
    const data = await res.json();

    // ç™ºè¡¨æ™‚åˆ»
    const updated = (data?.[0]?.reportDatetime) || (data?.[1]?.reportDatetime) || '';
    document.getElementById('jmaUpdated').textContent = updated || 'â€”';

    // 3æ—¥äºˆå ±ï¼ˆå¤©æ°—/é¢¨/æ³¢ï¼‰: data[0].timeSeries[0]
    const ts0 = data?.[0]?.timeSeries?.[0];
    const area0 = ts0?.areas?.find(a => a?.area?.name?.includes('æ±äº¬åœ°æ–¹')) || ts0?.areas?.[0];
    const days0 = ts0?.timeDefines || [];
    const weathers = area0?.weathers || [];
    const winds = area0?.winds || [];
    const waves = area0?.waves || [];
    const html0 = days0.map((t, i) =>
      `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
       <div>${weathers?.[i]||''}</div>
       <div class="small muted">${winds?.[i]||''}</div>
       <div class="small muted">${waves?.[i]||''}</div></div>`
    ).join('');
    document.getElementById('jma3d').innerHTML = `<div class="grid">${html0}</div>`;

    // é™æ°´ç¢ºç‡ï¼ˆ6æ™‚é–“ï¼‰: data[0].timeSeries[1]
    const ts1 = data?.[0]?.timeSeries?.[1];
    const area1 = ts1?.areas?.find(a => a?.area?.name?.includes('æ±äº¬åœ°æ–¹')) || ts1?.areas?.[0];
    const pops = area1?.pops || [];
    const html1 = (ts1?.timeDefines||[]).map((t,i) =>
      `<div class="cell"><div>${new Date(t).toLocaleString('ja-JP',{month:'short',day:'numeric',hour:'2-digit'})}</div>
       <div>${pops?.[i]||''}%</div></div>`
    ).join('');
    document.getElementById('jmaPop').innerHTML = `<div class="grid">${html1}</div>`;

    // æ°—æ¸©ï¼ˆæœ€é«˜/æœ€ä½ï¼‰: data[0].timeSeries[2] ã‚¨ãƒªã‚¢åã«ã€Œæ±äº¬ã€ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’æ¡ç”¨
    const ts2 = data?.[0]?.timeSeries?.[2];
    const area2 = ts2?.areas?.find(a => a?.area?.name?.includes('æ±äº¬')) || ts2?.areas?.[0];
    const temps = area2?.temps || [];
    const html2 = (ts2?.timeDefines||[]).map((t,i) =>
      `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
       <div>${temps?.[i]||''}â„ƒ</div></div>`
    ).join('');
    document.getElementById('jmaTemp').innerHTML = `<div class="grid">${html2}</div>`;

    // é€±é–“å¤©æ°—: data[1].timeSeries[0]ï¼ˆå¤©æ°—ã‚³ãƒ¼ãƒ‰/ä¿¡é ¼åº¦ãªã©ï¼‰
    const tsW = data?.[1]?.timeSeries?.[0];
    const areaW = tsW?.areas?.find(a => a?.area?.name?.includes('æ±äº¬åœ°æ–¹')) || tsW?.areas?.[0];
    const wDefs = tsW?.timeDefines || [];
    const wCodes = areaW?.weatherCodes || [];
    const reli = areaW?.reliabilities || [];
    const weekHtml = wDefs.map((t,i) => {
      const code = wCodes?.[i] || '';
      // å¤©æ°—ã‚³ãƒ¼ãƒ‰â†’ç°¡æ˜“ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ100:æ™´/200:æ›‡/300:é›¨/â€¦ï¼‰â€»ç°¡ç•¥
      const label = code.startsWith('1') ? 'æ™´' : code.startsWith('2') ? 'æ›‡' : code.startsWith('3') ? 'é›¨' : 'â€”';
      const rc = reli?.[i]||'';
      return `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
              <div>${label} <span class="small muted">${code}</span></div>
              <div class="small muted">ä¿¡é ¼åº¦: ${rc}</div></div>`;
    }).join('');
    document.getElementById('jmaWeekly').innerHTML = `<div class="grid">${weekHtml}</div>`;
  } catch (e) {
    document.getElementById('jma3d').innerHTML = `<span class="error">JMAã®å–å¾—ã«å¤±æ•—ï¼š${e}</span>`;
  }
})();

/** ===== â‘¡ AMeDAS æœ€æ–°è¦³æ¸¬å€¤ =====
 *  latest_time.txt â†’ map/{timestamp}.json ã‚’èª­ã‚“ã§ã€æŒ‡å®šè¦³æ¸¬æ‰€IDã®å€¤ã‚’è¡¨ç¤º
 */
document.getElementById('amdLoad').addEventListener('click', async () => {
  const id = document.getElementById('amdId').value.trim();
  const metaEl = document.getElementById('amdMeta');
  const valsEl = document.getElementById('amdVals');
  metaEl.textContent = 'å–å¾—ä¸­...';
  valsEl.textContent = 'â€”';
  try {
    const lt = await fetch('https://www.jma.go.jp/bosai/amedas/data/latest_time.txt').then(r=>r.text());
    const ts = lt.replace(/[-:T]/g,'').replace('+0900',''); // YYYYMMDDHHMMSS
    const url = `https://www.jma.go.jp/bosai/amedas/data/map/${ts}.json`;
    const m = await fetch(url).then(r=>r.json());
    const point = m[id];
    if (!point) { metaEl.innerHTML = `<span class="error">è¦³æ¸¬æ‰€ID ${id} ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>`; return; }
    // è¦³æ¸¬è¦ç´ ã¯ [å€¤, å“è³ªã‚³ãƒ¼ãƒ‰] å½¢å¼
    const first = (arr)=> Array.isArray(arr) && arr[0]!=null ? arr[0] : null;
    const temp = first(point.temp);
    const hum  = first(point.humidity);
    const rain1h = first(point.precipitation1h);
    const wind = first(point.wind);
    const wdir = first(point.windDirection);
    metaEl.innerHTML = `è¦³æ¸¬æ‰€ID: <strong>${id}</strong> ï½œ å–å¾—æ™‚åˆ»: ${lt}`;
    valsEl.innerHTML = `
      <div>æ°—æ¸©: <strong>${temp??'â€”'}</strong> â„ƒã€€æ¹¿åº¦: <strong>${hum??'â€”'}</strong>%</div>
      <div>1hé™æ°´: <strong>${rain1h??'â€”'}</strong> mmã€€é¢¨é€Ÿ: <strong>${wind??'â€”'}</strong> m/sã€€é¢¨å‘ã‚³ãƒ¼ãƒ‰: ${wdir??'â€”'}</div>
      <div class="small muted">â€»è¦ç´ ã¯è¦³æ¸¬æ‰€ã”ã¨ã«æœ‰ç„¡ã‚ã‚Š</div>
    `;
  } catch (e) {
    metaEl.innerHTML = `<span class="error">AMeDASå–å¾—ã«å¤±æ•—ï¼š${e}</span>`;
  }
});

/** ===== â‘¢ OpenWeatherMap å¸‚éƒ¨ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆ =====
 *  ç¾åœ¨ï¼†5æ—¥ï¼ˆ3æ™‚é–“åˆ»ã¿ï¼‰ã€‚APIã‚­ãƒ¼å¿…é ˆã€‚
 */
document.getElementById('owmLoad').addEventListener('click', async () => {
  const key = document.getElementById('owmKey').value.trim();
  const city = document.getElementById('owmCity').value.trim();
  const st = document.getElementById('owmStatus');
  const curEl = document.getElementById('owmCurrent');
  const fEl = document.getElementById('owm5d');
  if (!key) { st.innerHTML = '<span class="error">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>'; return; }
  st.textContent = 'å–å¾—ä¸­...';
  curEl.textContent = 'â€”';
  fEl.textContent = 'â€”';
  try {
    // ç¾åœ¨
    const curUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${key}&units=metric&lang=ja`;
    const cur = await fetch(curUrl).then(r=>r.json());
    curEl.innerHTML = `
      <div>éƒ½å¸‚: <strong>${cur.name}</strong>ï¼ˆ${(cur.sys||{}).country||''}ï¼‰</div>
      <div>å¤©æ°—: <strong>${cur.weather?.[0]?.description||'â€”'}</strong> / æ°—æ¸©: <strong>${cur.main?.temp??'â€”'}</strong> â„ƒ / æ¹¿åº¦: ${cur.main?.humidity??'â€”'}%</div>
      <div class="small muted">é¢¨ ${cur.wind?.speed??'â€”'} m/s / æ°—åœ§ ${cur.main?.pressure??'â€”'} hPa / ä½“æ„Ÿ ${cur.main?.feels_like??'â€”'} â„ƒ</div>
    `;
    // 5æ—¥ï¼ˆ3æ™‚é–“åˆ»ã¿ï¼‰
    const fUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${key}&units=metric&lang=ja`;
    const fc = await fetch(fUrl).then(r=>r.json());
    const cells = (fc.list||[]).slice(0, 14).map(x => {
      const t = new Date(x.dt*1000).toLocaleString('ja-JP',{month:'short',day:'numeric',hour:'2-digit'});
      const temp = Math.round(x.main.temp);
      const pop = Math.round((x.pop||0)*100);
      const desc = x.weather?.[0]?.description || '';
      return `<div class="cell"><div>${t}</div><div>${desc}</div><div>${temp}â„ƒ / é™æ°´${pop}%</div></div>`;
    }).join('');
    fEl.innerHTML = `<div class="grid">${cells}</div>`;
    st.textContent = 'OK';
  } catch (e) {
    st.innerHTML = `<span class="error">OpenWeatherå–å¾—ã«å¤±æ•—ï¼š${e}</span>`;
  }
});
</script>
</body>
</html>

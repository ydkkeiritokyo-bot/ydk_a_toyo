
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>東京都・市部ピンポイント天気（JMA + OpenWeather + AMeDAS）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; margin: 0; background:#0f172a; color:#e5e7eb;}
    header { padding: 16px 20px; border-bottom: 1px solid #334155;}
    h1 { font-size: 18px; margin: 0; }
    main { display: grid; gap: 16px; padding: 16px; }
    section { background:#111827; border: 1px solid #374151; border-radius: 10px; padding: 16px; }
    section h2 { font-size: 16px; margin: 0 0 8px; }
    .row { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .card { background:#0b1221; border: 1px solid #1f2937; border-radius: 8px; padding: 10px; }
    .small { font-size: 12px; opacity:.8 }
    .ok { color:#22c55e } .warn { color:#f59e0b } .bad { color:#ef4444 }
    .grid { display: grid; gap: 6px; grid-template-columns: repeat(7,1fr); }
    .grid .cell { padding: 6px; border: 1px solid #374151; border-radius:6px; text-align:center; font-size:13px; }
    label { display:block; margin: 4px 0 8px; }
    input, select, button { font: inherit; border-radius: 6px; border: 1px solid #374151; background:#0b1221; color:#e5e7eb; padding: 8px; }
    button { cursor: pointer; }
    .flex { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color:#94a3b8; }
    .error { color:#ef4444; }
    .footnote { font-size:11px; color:#a1a1aa; }
    a { color:#93c5fd; }
  </style>
</head>
<body>
<header>
  <h1>東京都・市部ピンポイント天気</h1>
  <div class="small muted">データ出典：気象庁/JMA（都県予報＆AMeDAS）、OpenWeatherMap（市部ピンポイント予報）。</div>
</header>

<main>
  <!-- ① JMA：東京都の3日/7日予報（APIキー不要） -->
  <section id="jma">
    <h2>東京都の予報（JMA）</h2>
    <div class="small muted">更新：<span id="jmaUpdated">読み込み中...</span>｜対象：東京地方（3日）＋週間（7日）</div>
    <div class="row">
      <div class="card">
        <div><strong>3日間の天気・風</strong></div>
        <div id="jma3d">読み込み中...</div>
      </div>
      <div class="card">
        <div><strong>降水確率（6時間区切り）</strong></div>
        <div id="jmaPop">読み込み中...</div>
      </div>
      <div class="card">
        <div><strong>気温（最高/最低）</strong></div>
        <div id="jmaTemp">読み込み中...</div>
      </div>
      <div class="card">
        <div><strong>週間天気（7日）</strong></div>
        <div id="jmaWeekly">読み込み中...</div>
      </div>
    </div>
    <div class="footnote">JMAの予報JSONは <code>/bosai/forecast/data/forecast/130000.json</code> を利用（東京都）。発表は通常 5時/11時/17時の1日3回。構造は3日予報＋週間予報で timeSeries が分かれる。 </div>
  </section>

  <!-- ② AMeDAS：近傍観測所の最新値（APIキー不要） -->
  <section id="amedas">
    <h2>今の気象（AMeDAS観測値）</h2>
    <div class="flex">
      <label>観測所ID（5桁）：<input id="amdId" value="44132" /></label>
      <button id="amdLoad">最新を取得</button>
      <span class="small muted">※観測所IDはJMAアメダスの詳細ページURL末尾の <code>#amdno=XXXXX</code> で確認可</span>
    </div>
    <div id="amdResult" class="row">
      <div class="card"><div id="amdMeta">読み込み待ち...</div></div>
      <div class="card"><div id="amdVals">—</div></div>
    </div>
    <div class="footnote">AMeDASの全国最新は <code>/bosai/amedas/data/latest_time.txt</code> → <code>/bosai/amedas/data/map/{YYYYMMDDHHMMSS}.json</code> の順で取得。各地点キーに観測値（気温/降水/風/湿度…）が配列で入る。</div>
  </section>

  <!-- ③ OpenWeatherMap：市部ピンポイント予報（APIキー要） -->
  <section id="owm">
    <h2>市部ピンポイント（OpenWeatherMap）</h2>
    <div class="flex">
      <label>APIキー：<input id="owmKey" placeholder="YOUR_OWM_API_KEY" /></label>
      <label>都市（例：Chofu,JP）：<input id="owmCity" value="Chofu,JP" /></label>
      <button id="owmLoad">取得</button>
    </div>
    <div id="owmStatus" class="small muted">未取得</div>
    <div class="row">
      <div class="card">
        <div><strong>現在の天気</strong></div>
        <div id="owmCurrent">—</div>
      </div>
      <div class="card">
        <div><strong>5日間（3時間刻み）</strong></div>
        <div id="owm5d">—</div>
      </div>
    </div>
    <div class="footnote">OpenWeatherの現在・5日予報APIを利用（言語=ja、単位=metric）。無料枠あり。都市名または緯度経度で指定可能。</div>
  </section>
</main>

<script>
/** ===== ① JMA 東京都の予報 =====
 *  参照: https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json
 *  3日予報/週間予報の timeSeries を整形して表形式で出す
 */
(async function loadJMA() {
  const url = 'https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json';
  try {
    const res = await fetch(url);
    const data = await res.json();

    // 発表時刻
    const updated = (data?.[0]?.reportDatetime) || (data?.[1]?.reportDatetime) || '';
    document.getElementById('jmaUpdated').textContent = updated || '—';

    // 3日予報（天気/風/波）: data[0].timeSeries[0]
    const ts0 = data?.[0]?.timeSeries?.[0];
    const area0 = ts0?.areas?.find(a => a?.area?.name?.includes('東京地方')) || ts0?.areas?.[0];
    const days0 = ts0?.timeDefines || [];
    const weathers = area0?.weathers || [];
    const winds = area0?.winds || [];
    const waves = area0?.waves || [];
    const html0 = days0.map((t, i) =>
      `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
       <div>${weathers?.[i]||''}</div>
       <div class="small muted">${winds?.[i]||''}</div>
       <div class="small muted">${waves?.[i]||''}</div></div>`
    ).join('');
    document.getElementById('jma3d').innerHTML = `<div class="grid">${html0}</div>`;

    // 降水確率（6時間）: data[0].timeSeries[1]
    const ts1 = data?.[0]?.timeSeries?.[1];
    const area1 = ts1?.areas?.find(a => a?.area?.name?.includes('東京地方')) || ts1?.areas?.[0];
    const pops = area1?.pops || [];
    const html1 = (ts1?.timeDefines||[]).map((t,i) =>
      `<div class="cell"><div>${new Date(t).toLocaleString('ja-JP',{month:'short',day:'numeric',hour:'2-digit'})}</div>
       <div>${pops?.[i]||''}%</div></div>`
    ).join('');
    document.getElementById('jmaPop').innerHTML = `<div class="grid">${html1}</div>`;

    // 気温（最高/最低）: data[0].timeSeries[2] エリア名に「東京」が含まれるものを採用
    const ts2 = data?.[0]?.timeSeries?.[2];
    const area2 = ts2?.areas?.find(a => a?.area?.name?.includes('東京')) || ts2?.areas?.[0];
    const temps = area2?.temps || [];
    const html2 = (ts2?.timeDefines||[]).map((t,i) =>
      `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
       <div>${temps?.[i]||''}℃</div></div>`
    ).join('');
    document.getElementById('jmaTemp').innerHTML = `<div class="grid">${html2}</div>`;

    // 週間天気: data[1].timeSeries[0]（天気コード/信頼度など）
    const tsW = data?.[1]?.timeSeries?.[0];
    const areaW = tsW?.areas?.find(a => a?.area?.name?.includes('東京地方')) || tsW?.areas?.[0];
    const wDefs = tsW?.timeDefines || [];
    const wCodes = areaW?.weatherCodes || [];
    const reli = areaW?.reliabilities || [];
    const weekHtml = wDefs.map((t,i) => {
      const code = wCodes?.[i] || '';
      // 天気コード→簡易テキスト（100:晴/200:曇/300:雨/…）※簡略
      const label = code.startsWith('1') ? '晴' : code.startsWith('2') ? '曇' : code.startsWith('3') ? '雨' : '—';
      const rc = reli?.[i]||'';
      return `<div class="cell"><div>${new Date(t).toLocaleDateString('ja-JP',{month:'short',day:'numeric'})}</div>
              <div>${label} <span class="small muted">${code}</span></div>
              <div class="small muted">信頼度: ${rc}</div></div>`;
    }).join('');
    document.getElementById('jmaWeekly').innerHTML = `<div class="grid">${weekHtml}</div>`;
  } catch (e) {
    document.getElementById('jma3d').innerHTML = `<span class="error">JMAの取得に失敗：${e}</span>`;
  }
})();

/** ===== ② AMeDAS 最新観測値 =====
 *  latest_time.txt → map/{timestamp}.json を読んで、指定観測所IDの値を表示
 */
document.getElementById('amdLoad').addEventListener('click', async () => {
  const id = document.getElementById('amdId').value.trim();
  const metaEl = document.getElementById('amdMeta');
  const valsEl = document.getElementById('amdVals');
  metaEl.textContent = '取得中...';
  valsEl.textContent = '—';
  try {
    const lt = await fetch('https://www.jma.go.jp/bosai/amedas/data/latest_time.txt').then(r=>r.text());
    const ts = lt.replace(/[-:T]/g,'').replace('+0900',''); // YYYYMMDDHHMMSS
    const url = `https://www.jma.go.jp/bosai/amedas/data/map/${ts}.json`;
    const m = await fetch(url).then(r=>r.json());
    const point = m[id];
    if (!point) { metaEl.innerHTML = `<span class="error">観測所ID ${id} のデータが見つかりません</span>`; return; }
    // 観測要素は [値, 品質コード] 形式
    const first = (arr)=> Array.isArray(arr) && arr[0]!=null ? arr[0] : null;
    const temp = first(point.temp);
    const hum  = first(point.humidity);
    const rain1h = first(point.precipitation1h);
    const wind = first(point.wind);
    const wdir = first(point.windDirection);
    metaEl.innerHTML = `観測所ID: <strong>${id}</strong> ｜ 取得時刻: ${lt}`;
    valsEl.innerHTML = `
      <div>気温: <strong>${temp??'—'}</strong> ℃　湿度: <strong>${hum??'—'}</strong>%</div>
      <div>1h降水: <strong>${rain1h??'—'}</strong> mm　風速: <strong>${wind??'—'}</strong> m/s　風向コード: ${wdir??'—'}</div>
      <div class="small muted">※要素は観測所ごとに有無あり</div>
    `;
  } catch (e) {
    metaEl.innerHTML = `<span class="error">AMeDAS取得に失敗：${e}</span>`;
  }
});

/** ===== ③ OpenWeatherMap 市部ピンポイント =====
 *  現在＆5日（3時間刻み）。APIキー必須。
 */
document.getElementById('owmLoad').addEventListener('click', async () => {
  const key = document.getElementById('owmKey').value.trim();
  const city = document.getElementById('owmCity').value.trim();
  const st = document.getElementById('owmStatus');
  const curEl = document.getElementById('owmCurrent');
  const fEl = document.getElementById('owm5d');
  if (!key) { st.innerHTML = '<span class="error">APIキーを入力してください</span>'; return; }
  st.textContent = '取得中...';
  curEl.textContent = '—';
  fEl.textContent = '—';
  try {
    // 現在
    const curUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${key}&units=metric&lang=ja`;
    const cur = await fetch(curUrl).then(r=>r.json());
    curEl.innerHTML = `
      <div>都市: <strong>${cur.name}</strong>（${(cur.sys||{}).country||''}）</div>
      <div>天気: <strong>${cur.weather?.[0]?.description||'—'}</strong> / 気温: <strong>${cur.main?.temp??'—'}</strong> ℃ / 湿度: ${cur.main?.humidity??'—'}%</div>
      <div class="small muted">風 ${cur.wind?.speed??'—'} m/s / 気圧 ${cur.main?.pressure??'—'} hPa / 体感 ${cur.main?.feels_like??'—'} ℃</div>
    `;
    // 5日（3時間刻み）
    const fUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${key}&units=metric&lang=ja`;
    const fc = await fetch(fUrl).then(r=>r.json());
    const cells = (fc.list||[]).slice(0, 14).map(x => {
      const t = new Date(x.dt*1000).toLocaleString('ja-JP',{month:'short',day:'numeric',hour:'2-digit'});
      const temp = Math.round(x.main.temp);
      const pop = Math.round((x.pop||0)*100);
      const desc = x.weather?.[0]?.description || '';
      return `<div class="cell"><div>${t}</div><div>${desc}</div><div>${temp}℃ / 降水${pop}%</div></div>`;
    }).join('');
    fEl.innerHTML = `<div class="grid">${cells}</div>`;
    st.textContent = 'OK';
  } catch (e) {
    st.innerHTML = `<span class="error">OpenWeather取得に失敗：${e}</span>`;
  }
});
</script>
</body>
</html>
